<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2021-02-12">

<title>blog - Live Streaming Video + Audio on Raspberry Pi using USB Camera and Microphone</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">blog</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html" rel="" target="">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/pramodatre" rel="" target=""><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/pramodatre" rel="" target=""><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Live Streaming Video + Audio on Raspberry Pi using USB Camera and Microphone</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">baby monitor</div>
                <div class="quarto-category">raspberry pi</div>
                <div class="quarto-category">usb camera</div>
                <div class="quarto-category">usb microphone</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">February 12, 2021</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>There may be many applications such as wildlife monitoring, baby monitoring, or in general security system applications where you may need to monitor both video and audio stream. One such example of using audio is the <a href="https://www.kaggle.com/c/rfcx-species-audio-detection">Rainforest Connection Species Audio Detection</a> challenge on Kaggle. I wanted to use Raspberry Pi to accomplish video + audio streaming using USB camera and a USB microphone. I have this special requirement since I did not want to buy a Pi Camera as I already have a good quality USB camera and just wanted to use this. Most of the references I was able to find used Raspberry Pi Camera and it was quite confusing for me to navigate this space.</p>
<p>After a bit of struggle to find the relevant information I needed, I got both audio and video streaming working with Raspberry Pi + USB camera + USB microphone. This post is to summarize my findings so that it may be helpful for someone with similar requirements.</p>
<p>There may be many approaches but the most straightforward one for me was to use <a href="https://www.linux-projects.org/uv4l/">UV4L</a> streaming server, specifically, the two-way audio/video intercom recorder, WebRTC. However, for my purpose, I only need one way stream from USB camera and microphone connected to the Raspberry Pi. WebRTC provides a web UI you can use to start or end the stream from the server.</p>
<section id="step-1-install-uv4l" class="level2">
<h2 class="anchored" data-anchor-id="step-1-install-uv4l">Step 1: Install UV4L</h2>
<ul>
<li>Follow the instructions <a href="https://www.linux-projects.org/uv4l/installation/">here</a>. For completeness, I will outline the steps I followed here.</li>
<li>Since I have <code>Raspbian Buster</code> on my Pi, I used the following command</li>
</ul>
<pre class="code"><code>curl https://www.linux-projects.org/listing/uv4l_repo/lpkey.asc | sudo apt-key add -</code></pre>
<ul>
<li>I add this line to the file <code>/etc/apt/sources.list</code></li>
</ul>
<pre class="code"><code>deb https://www.linux-projects.org/listing/uv4l_repo/raspbian/stretch stretch main</code></pre>
<ul>
<li>Next run the install commands</li>
</ul>
<pre class="code"><code>$ sudo apt-get update
$ sudo apt-get install uv4l uv4l-raspicam</code></pre>
<p>I stopped here as I just wanted to setup a video + audio stream for a monitoring application and did not really need the uv4l-raspicam-ai modules.</p>
</section>
<section id="step-2-configure-usb-camera" class="level2">
<h2 class="anchored" data-anchor-id="step-2-configure-usb-camera">Step 2: Configure USB camera</h2>
<ul>
<li>Follow the instructions on configuring UV4L or WebRTC using a USB camera <a href="https://raspberrypi.stackexchange.com/questions/39690/configuring-uv4l-for-webrtc-using-usb-camera-on-rpi2-raspbian">here</a>. Here are the steps I followed.</li>
<li>Installed the following packages</li>
</ul>
<pre class="code"><code>sudo apt-get install uv4l uv4l-server uv4l-uvc uv4l-server uv4l-webrtc uv4l-xmpp-bridge</code></pre>
<ul>
<li>Used the dmesg command to find the USB camera device id</li>
</ul>
<pre class="code"><code>$ dmesg</code></pre>
<p>An excerpt from the output here:</p>
<pre class="shell"><code>[    7.824796] mc: Linux media interface: v0.10
[    7.889277] videodev: Linux video capture interface: v2.00
[    8.072950] uvcvideo: Found UVC 1.00 device H264 USB Camera (05a3:9422)
[    8.168458] input: H264 USB Camera: USB Camera as /devices/platform/soc/3f980000.usb/usb1/1-1/1-1.5/1-1.5:1.0/input/input8
[    8.169582] usbcore: registered new interface driver uvcvideo
[    8.169736] USB Video Class driver (1.1.1)</code></pre>
<ul>
<li>Ran this command to add the hex device ID on line three in the above output.</li>
</ul>
<pre class="code"><code>$ uv4l --syslog-host localhost --driver uvc --device-id 05a3:9422</code></pre>
<ul>
<li>I got this output indicating that the camera was indeed detected successfully.</li>
</ul>
<pre class="code"><code>&lt;notice&gt; [core] Trying to loading driver 'uvc' from built-in drivers...
&lt;notice&gt; [core] Loading driver 'uvc' from external plug-in's...
&lt;notice&gt; [driver] Video functionality 'USB Camera' recognized at 05a3:9422
&lt;notice&gt; [core] Device detected!
&lt;notice&gt; [core] Registering device node /dev/uv4l</code></pre>
<ul>
<li>Changed driver to <code>uvc</code> in <code>/etc/uv4l/uv4l-raspicam.conf</code></li>
</ul>
<pre class="code"><code>driver = uvc</code></pre>
<ul>
<li>Reboot the Raspberry Pi using</li>
</ul>
<pre class="code"><code>$ sudo reboot</code></pre>
<p>Once the Pi is up, check the following url (note the port is not 8080! It’s http://pi_ip_address:8090/) on the client where you want to receive the stream – in my case, this is my laptop. I used chrome as my browser. You should see a page like this.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="uv4l_main_page.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Main page of the UV4L streaming server</figcaption>
</figure>
</div>
<p>Click on the WebRTC (first icon) on the page and you end up with a page where you can connect to the stream on the client.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="webrtc_page.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">WebRTC page of the UV4L streaming server</figcaption>
</figure>
</div>
<p>You will see a button called <code>Call</code> (in green) in the bottom left part of the page. Just click it and you should start receiving the video stream like this. <img src="webrtc_with_streams.png" class="img-fluid" alt="WebRTC page displaying the stream of the USB camera"></p>
<blockquote class="blockquote">
<p>I have pointed the camera to the Pi since I wanted to check the delay in frames over my WiFi using the periodic blinking light on the LAN cable. The delay I noticed in video is acceptable for my purpose. As of now, you would notice that the audio is still not streaming.</p>
</blockquote>
</section>
<section id="step-3-configure-usb-microphone" class="level2">
<h2 class="anchored" data-anchor-id="step-3-configure-usb-microphone">Step 3: Configure USB microphone</h2>
<ul>
<li>Follow <a href="https://www.raspberrypi.org/forums/viewtopic.php?f=41&amp;t=230542&amp;p=1558833&amp;sid=5aff4015678bebbd51fe3ac23142dd84#p1558833">these</a> instructions partially to find your USB microphone and include it in the WebRTC server configuration. Here are steps I followed.</li>
<li>I executed the following command</li>
</ul>
<pre class="code"><code>$ arecord -L | grep CARD</code></pre>
<pre><code>default:CARD=Camera
sysdefault:CARD=Camera
front:CARD=Camera,DEV=0
surround21:CARD=Camera,DEV=0
surround40:CARD=Camera,DEV=0
surround41:CARD=Camera,DEV=0
surround50:CARD=Camera,DEV=0
surround51:CARD=Camera,DEV=0
surround71:CARD=Camera,DEV=0
iec958:CARD=Camera,DEV=0
dmix:CARD=Camera,DEV=0
dsnoop:CARD=Camera,DEV=0
hw:CARD=Camera,DEV=0
plughw:CARD=Camera,DEV=0
default:CARD=Microphones
sysdefault:CARD=Microphones
front:CARD=Microphones,DEV=0
surround21:CARD=Microphones,DEV=0
surround40:CARD=Microphones,DEV=0
surround41:CARD=Microphones,DEV=0
surround50:CARD=Microphones,DEV=0
surround51:CARD=Microphones,DEV=0
surround71:CARD=Microphones,DEV=0
iec958:CARD=Microphones,DEV=0
dmix:CARD=Microphones,DEV=0
dsnoop:CARD=Microphones,DEV=0
hw:CARD=Microphones,DEV=0
plughw:CARD=Microphones,DEV=0</code></pre>
<ul>
<li>A bit tricky, you have to literally count the lines starting from zero to your microphone device in the last line <code>plughw:CARD=Microphones,DEV=0</code>.</li>
<li><code>plughw:CARD=Microphones,DEV=0</code> is line 27 starting from zero for the first line.</li>
<li>In the file <code>/etc/uv4l/uv4l-raspicam.conf</code>, find the line that has the audio device index and set the index to the line number of you microphone. In my case, it’s 27.</li>
</ul>
<pre class="code"><code>server-option = --webrtc-recdevice-index=27</code></pre>
<p>Reboot the Raspberry Pi and you should be able to access the Video + Audio stream from Raspberry Pi on your WiFi at http:pi_ip_address:8090/stream/webrtc</p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>The setup of USB camera + USB microphone is something I had and wanted to utilize it without making additional purchases such as Pi Camera. This was a special requirement for me – there may be much simpler tools if you have a Pi Camera with you. This setup looks very reliable with millisecond level latency. Also, the service has been running for over a day as of my writing of this article.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>